function upload(e){if(0!==e.target.files.length){var $scope=angular.element(document.getElementById("tela")).scope(),campo=$scope.model.campos.find(atual=>atual.campo===e.target.id);if(void 0!==campo){var reader=new FileReader;reader.addEventListener("load",function(){$scope.view[campo.arquivo]=e.target.files[0];var img=new Image,canvas=document.createElement("canvas"),context=canvas.getContext("2d");img.onload=function(){canvas.width=img.width,canvas.height=img.height,context.drawImage(img,0,0);var jpg=canvas.toDataURL("image/jpeg",.7);$scope.view.selecionado[campo.campo]=jpg,$scope.$apply()},img.src=reader.result},!1),reader.readAsDataURL(e.target.files[0])}}}var app=angular.module("app",["ngRoute","ngSanitize","ngCookies","ngAnimate","ngLocale","ui.utils.masks"]),configs={urlApi:"https://abacate.herokuapp.com/app/",limiteRegistros:10},rotas={home:"/solicitacoes",login:"/login",solicitacao:"/solicitacao",generico:"/:rota"};app.config(function($routeProvider,$locationProvider){$locationProvider.html5Mode(!1),$routeProvider.when(rotas.login,{templateUrl:"views/login.html"}).when(rotas.solicitacao,{templateUrl:"views/solicitacao.html"}).when(rotas.generico,{templateUrl:"views/generic.html"}).otherwise({redirectTo:rotas.home})}),app.controller("mainController",function($scope,$location,$http,$cookies,$timeout,$rootScope){$scope.hoje=new Date,$scope.exibirCarregando=!0,$scope.requisicoesPendentes=0,$scope.botoes={busca:!1,novo:!1},$scope.sessao={id:0,nome:null,auth:null,logado:!1},$scope.$on("$routeChangeStart",function(){$scope.exibirCarregando=!0,$scope.sessao.logado||void 0!==$cookies.get("auth")||"/login"!==$location.path()&&"/solicitacao"!==$location.path()&&($location.path(rotas.login),$scope.exibirCarregando=!1)}),$scope.$on("$routeChangeSuccess",function(){$scope.exibirCarregando=!1}),$scope.api=function(url,metodo,dados,retorno,sucesso,erro,callback,parametros,exibirErro=!0){var config={url:configs.urlApi+url,method:metodo,data:dados,headers:{"Content-Type":"application/json",Authorization:$scope.sessao.auth}};$scope.requisicoesPendentes++,$http(config).then(function(result){$scope.requisicoesPendentes--,retorno[sucesso]=result.data,void 0!==callback&&callback(parametros)},function(error){$scope.requisicoesPendentes--,retorno[erro]=error.data.message,exibirErro?$scope.exibirNotificacao("Erro",retorno[erro],!0):void 0!==callback&&callback(parametros)})},$scope.exibirNotificacao=function(titulo,mensagem,erro){$scope.notificacao={ativo:!0,titulo:titulo,mensagem:mensagem,erro:erro},$timeout(function(){$scope.notificacao.ativo=!1},2e3)},$scope.exibirConfirmacao=function(mensagem,callback,param){$scope.confirmacao={ativo:!0,mensagem:mensagem,confirmar:()=>callback(param)}},$scope.login=function(dados){let retorno={},basic=$cookies.get("auth");if(void 0!==dados)if(basic=btoa(dados.usuario+":"+dados.senha),dados.permanecerConectado){let expira=new Date;expira.setDate($scope.hoje.getDate()+30),$cookies.put("auth",basic,{expires:expira})}else $cookies.remove("auth");if(void 0!==basic){$scope.sessao.auth=basic;let dados=atob(basic).split(":");dados={usuario:dados[0],senha:dados[1]},$scope.api("usuarios/autenticar","POST",dados,retorno,"sucesso","erro",function(){if(void 0===retorno.erro){let usuario=retorno.sucesso;$scope.sessao.id=usuario.id,$scope.sessao.nome=usuario.nome,$scope.sessao.logado=!0,$location.path()===rotas.login&&$location.path(rotas.home)}else $scope.exibirNotificacao("Erro","Usuário e/ou senha inválidos",!0),$scope.logout()},null,!1)}},$scope.logout=function(){$scope.sessao={id:0,nome:null,auth:null,logado:!1},$cookies.remove("auth"),$location.path(rotas.login)},$scope.recuperar=function(dados){let retorno={};dados.senha===dados.repetir?(delete dados.repetir,$scope.api("usuarios/resetarSenha","PATCH",dados,retorno,"sucesso","erro",function(){$scope.exibirNotificacao("Sucesso","Senha atualizada com sucesso!")})):$scope.exibirNotificacao("Erro","As senhas digitadas não são iguais, digite novamente",!0)},$scope.novo=function(){$rootScope.$emit("novo",{})},$scope.login(),$(window).scroll(function(){0!==$scope.sessao.id&&$(window).scrollTop()+$(window).height()==$(document).height()&&$rootScope.$emit("mais",{})})}),app.controller("genericController",function($scope,$routeParams,$http,$q,$location,$rootScope){$scope.carregado=!1,$scope.paginaAtual=0,$scope.ordenacao={campo:null,ordem:!1},$scope.iniciar=function(){$scope.requisicoesPendentes++;let arquivo="models/"+$routeParams.rota+".json";$http.get(arquivo).then(function(result){"object"==typeof result.data?($scope.model=result.data,$scope.view={registros:[],selecionado:{},pesquisa:""},$scope.listar(),$scope.requisicoesPendentes--,$scope.carregado=!0,$scope.model.novo.ativo&&($scope.botoes.novo=!0,$rootScope.$on("novo",function(){$scope.editar($scope.model.novo.objeto)})),$rootScope.$on("mais",function(){0===$scope.requisicoesPendentes&&$scope.view.registros.length===($scope.paginaAtual+1)*configs.limiteRegistros&&($scope.paginaAtual++,$scope.listar())})):($scope.exibirNotificacao("Erro","Falha ao carregar model",!0),$scope.requisicoesPendentes--)},function(error){$scope.exibirNotificacao("Erro","Falha ao carregar model",!0),$scope.requisicoesPendentes--})},$scope.listar=function(){let obj={};obj[$scope.model.busca.campo]=$scope.view.pesquisa;let url=$scope.model.url+"/pesquisar?";if(url+="pagina="+$scope.paginaAtual+"&quantidade="+configs.limiteRegistros,null!==$scope.ordenacao.campo){let ordem=$scope.ordenacao.ordem?"asc":"desc";url+="&atributoOrdenado="+$scope.ordenacao.campo+"&ordem="+ordem}$scope.api(url,"POST",obj,$scope,"registros","erros",function(){$scope.paginaAtual>0?$scope.view.registros=$scope.view.registros.concat($scope.registros):$scope.view.registros=$scope.registros})},$scope.editar=function(obj){if(angular.copy(obj,$scope.view.selecionado),void 0!==$scope.view.selecionado[$scope.model.chave])for(var i in $scope.model.campos){if("image"===$scope.model.campos[i].tipo){let url=$scope.model.url+"/"+$scope.view.selecionado[$scope.model.chave];$scope.api(url,"GET",null,$scope.view,"selecionado")}if("table"===$scope.model.campos[i].tipo){let atual=$scope.model.campos[i],url=atual.url+"/"+$scope.view.selecionado[atual.parametro];$scope.api(url,"GET",null,$scope.view.selecionado,atual.campo)}}$(".modal").modal()},$scope.salvar=function(){let retorno={},metodo="PATCH";if(void 0===$scope.view.selecionado[$scope.model.chave])metodo="POST";else for(var i in $scope.model.campos)if("table"===$scope.model.campos[i].tipo){let atual=$scope.model.campos[i],url=atual.url+"/"+$scope.view.selecionado[atual.parametro];$scope.api(url,"POST",$scope.view.selecionado[atual.campo])}$scope.api($scope.model.url,metodo,$scope.view.selecionado,retorno,"sucesso","erro",function(){$scope.exibirNotificacao("Sucesso","Registro salvo com sucesso!",!1),$(".modal").modal("toggle"),$scope.listar()})},$scope.excluir=function(id){$scope.exibirConfirmacao("Confirmar exclusão do registro?",function(){let retorno={};$scope.api($scope.model.url+"/"+id,"DELETE",null,retorno,"sucesso","erro",function(){$scope.exibirNotificacao("Sucesso","Registro excluído com sucesso!",!1),$scope.listar()})})},$scope.ordenar=function(campo){$scope.ordenacao.campo===campo&&($scope.ordenacao.ordem=!$scope.ordenacao.ordem),$scope.ordenacao.campo=campo,$scope.paginaAtual=0,$scope.listar()}});