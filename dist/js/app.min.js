var app=angular.module("app",["ngRoute","ngSanitize","ngCookies","ngAnimate","ngLocale"]),configs={urlApi:"https://abacate.herokuapp.com/app/"},rotas={home:"/solicitacoes",login:"/login",solicitacao:"/solicitacao",generico:"/:rota"};app.config(function($routeProvider,$locationProvider){$locationProvider.html5Mode(!0),$routeProvider.when(rotas.login,{templateUrl:"views/login.html"}).when(rotas.solicitacao,{templateUrl:"views/solicitacao.html"}).when(rotas.generico,{templateUrl:"views/generic.html"}).otherwise({redirectTo:rotas.home})}),app.controller("mainController",function($scope,$location,$http,$cookies,$timeout){$scope.hoje=new Date,$scope.exibirCarregando=!0,$scope.requisicoesPendentes=0,$scope.sessao={id:0,nome:null,auth:null,logado:!1},$scope.$on("$routeChangeStart",function(){$scope.exibirCarregando=!0,$scope.sessao.logado||"/login"!==$location.path()&&"/solicitacao"!==$location.path()&&$location.path(rotas.login)}),$scope.$on("$routeChangeSuccess",function(){$scope.exibirCarregando=!1}),$scope.api=function(url,metodo,dados,retorno,sucesso,erro,callback,parametros){var config={url:configs.urlApi+url,method:metodo,data:dados,headers:{"Content-Type":"application/json",Autorization:"Basic "+$scope.sessao.auth}};$scope.requisicoesPendentes++,$http(config).then(function(result){$scope.requisicoesPendentes--,retorno[sucesso]=result.data,void 0!==callback&&callback(parametros)},function(error){$scope.requisicoesPendentes--,retorno[erro]=error.statusText,$scope.exibirNotificacao("Erro",retorno.erro,!0)})},$scope.exibirNotificacao=function(titulo,mensagem,erro){$scope.notificacao={ativo:!0,titulo:titulo,mensagem:mensagem,erro:erro},$timeout(function(){$scope.notificacao.ativo=!1},3e3)},$scope.login=function(){let retorno={},basic=$cookies.get("auth");if(void 0!==$scope.login)if(basic=btoa($scope.login.usuario+":"+$scope.login.senha),$scope.login.permanecerConectado){let expira=new Date($scope.hoje+30);$cookies.put("auth",basic,{expires:expira})}else $cookies.remove("auth");void 0!==basic&&($scope.sessao.auth=basic,$scope.api("usuarios","GET",null,retorno,"sucesso","erro",function(){$scope.sessao.logado=!0,$location.path(rotas.home)}))},$scope.logout=function(){$scope.sessao={id:0,nome:null,auth:null,logado:!1},$cookies.remove("auth"),$location.path(rotas.login)},$scope.login()}),app.controller("genericController",function($scope,$routeParams,$http,$q){$scope.iniciar=function(){$scope.exibirCarregando=!0;let arquivo="models/"+$routeParams.rota+".json";$http.get(arquivo).then(function(result){"object"==typeof result.data?($scope.model=result.data,$scope.view={registros:[],selecionado:{},pesquisa:""},$scope.listar()):$scope.exibirNotificacao("Erro","Falha ao carregar model",!0),$scope.exibirCarregando=!1})},$scope.listar=function(){$scope.api($scope.model.url,"GET",$scope.view.pesquisa,$scope.view,"registros")},$scope.editar=function(obj){angular.copy(obj,$scope.view.selecionado),$(".modal").modal()},$scope.salvar=function(){let retorno={},metodo="PATCH";void 0===$scope.view.selecionado[$scope.model.chave]&&(metodo="POST"),$scope.api($scope.model.url,metodo,$scope.view.selecionado,retorno,"sucesso","erro",function(){$scope.exibirNotificacao("Sucesso","Registro salvo com sucesso!",!1),$(".modal").modal("toggle"),$scope.listar()})},$scope.excluir=function(id){if(confirm("Confirmar exclusão do registro?")){let retorno={};$scope.api($scope.model.url+"/"+id,"DELETE",null,retorno,"sucesso","erro",function(){$scope.exibirNotificacao("Sucesso","Registro excluído com sucesso!",!1),$scope.listar()})}}});