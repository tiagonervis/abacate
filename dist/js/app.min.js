function upload(e){if(0!==e.target.files.length){var $scope=angular.element(document.getElementById("tela")).scope(),campo=$scope.model.campos.find(atual=>atual.campo===e.target.id);if(void 0!==campo){var reader=new FileReader;reader.addEventListener("load",function(){$scope.view[campo.arquivo]=e.target.files[0];var img=new Image,canvas=document.createElement("canvas"),context=canvas.getContext("2d");img.onload=function(){canvas.width=img.width,canvas.height=img.height,context.drawImage(img,0,0);var jpg=canvas.toDataURL("image/jpeg",.7);$scope.view.selecionado[campo.campo]=jpg,$scope.$apply()},img.src=reader.result},!1),reader.readAsDataURL(e.target.files[0])}}}var app=angular.module("app",["ngRoute","ngSanitize","ngCookies","ngAnimate","ngLocale"]),configs={urlApi:"https://abacate.herokuapp.com/app/"},rotas={home:"/solicitacoes",login:"/login",solicitacao:"/solicitacao",generico:"/:rota"};app.config(function($routeProvider,$locationProvider){$locationProvider.html5Mode(!0),$routeProvider.when(rotas.login,{templateUrl:"views/login.html"}).when(rotas.solicitacao,{templateUrl:"views/solicitacao.html"}).when(rotas.generico,{templateUrl:"views/generic.html"}).otherwise({redirectTo:rotas.home})}),app.controller("mainController",function($scope,$location,$http,$cookies,$timeout){$scope.hoje=new Date,$scope.exibirCarregando=!0,$scope.requisicoesPendentes=0,$scope.sessao={id:0,nome:null,auth:null,logado:!1},$scope.$on("$routeChangeStart",function(){$scope.exibirCarregando=!0,$scope.sessao.logado||void 0!==$cookies.get("auth")||"/login"!==$location.path()&&"/solicitacao"!==$location.path()&&$location.path(rotas.login)}),$scope.$on("$routeChangeSuccess",function(){$scope.exibirCarregando=!1}),$scope.api=function(url,metodo,dados,retorno,sucesso,erro,callback,parametros,exibirErro=!0){var config={url:configs.urlApi+url,method:metodo,data:dados,headers:{"Content-Type":"application/json",Authorization:$scope.sessao.auth}};$scope.requisicoesPendentes++,$http(config).then(function(result){$scope.requisicoesPendentes--,retorno[sucesso]=result.data,void 0!==callback&&callback(parametros)},function(error){$scope.requisicoesPendentes--,retorno[erro]=error.statusText,exibirErro?$scope.exibirNotificacao("Erro",retorno.erro,!0):void 0!==callback&&callback(parametros)})},$scope.exibirNotificacao=function(titulo,mensagem,erro){$scope.notificacao={ativo:!0,titulo:titulo,mensagem:mensagem,erro:erro},$timeout(function(){$scope.notificacao.ativo=!1},2e3)},$scope.login=function(dados){let retorno={},basic=$cookies.get("auth");if(void 0!==dados)if(basic=btoa(dados.usuario+":"+dados.senha),dados.permanecerConectado){let expira=new Date($scope.hoje+30);$cookies.put("auth",basic,{expires:expira})}else $cookies.remove("auth");if(void 0!==basic){$scope.sessao.auth=basic;let dados=atob(basic).split(":");dados={usuario:dados[0],senha:dados[1]},$scope.api("usuarios/autenticar","POST",dados,retorno,"sucesso","erro",function(){if(void 0===retorno.erro){let usuario=retorno.sucesso;$scope.sessao.id=usuario.id,$scope.sessao.nome=usuario.nome,$scope.sessao.logado=!0,$location.path()===rotas.login&&$location.path(rotas.home)}else $scope.exibirNotificacao("Erro","Usuário e/ou senha inválidos",!0),$scope.logout()},null,!1)}},$scope.logout=function(){$scope.sessao={id:0,nome:null,auth:null,logado:!1},$cookies.remove("auth"),$location.path(rotas.login)},$scope.login()}),app.controller("genericController",function($scope,$routeParams,$http,$q){$scope.iniciar=function(){$scope.exibirCarregando=!0;let arquivo="models/"+$routeParams.rota+".json";$http.get(arquivo).then(function(result){"object"==typeof result.data?($scope.model=result.data,$scope.view={registros:[],selecionado:{},pesquisa:""},$scope.listar()):$scope.exibirNotificacao("Erro","Falha ao carregar model",!0),$scope.exibirCarregando=!1})},$scope.listar=function(){$scope.api($scope.model.url,"GET",$scope.view.pesquisa,$scope.view,"registros")},$scope.editar=function(obj){angular.copy(obj,$scope.view.selecionado),$(".modal").modal()},$scope.salvar=function(){let retorno={},metodo="PATCH";void 0===$scope.view.selecionado[$scope.model.chave]&&(metodo="POST"),$scope.api($scope.model.url,metodo,$scope.view.selecionado,retorno,"sucesso","erro",function(){$scope.exibirNotificacao("Sucesso","Registro salvo com sucesso!",!1),$(".modal").modal("toggle"),$scope.listar()})},$scope.excluir=function(id){if(confirm("Confirmar exclusão do registro?")){let retorno={};$scope.api($scope.model.url+"/"+id,"DELETE",null,retorno,"sucesso","erro",function(){$scope.exibirNotificacao("Sucesso","Registro excluído com sucesso!",!1),$scope.listar()})}}});