function upload(e){if(0!==e.target.files.length){var $scope=angular.element(document.getElementById("tela")).scope(),campo=$scope.model.campos.find(atual=>atual.campo===e.target.id);if(void 0!==campo){var reader=new FileReader;reader.addEventListener("load",function(){$scope.view[campo.arquivo]=e.target.files[0];var img=new Image,canvas=document.createElement("canvas"),context=canvas.getContext("2d");img.onload=function(){var divisor=1;img.width>1e3&&(divisor=img.width/1e3),img.height/divisor>700&&(divisor=img.height/700),canvas.width=img.width/divisor,canvas.height=img.height/divisor,context.drawImage(img,0,0,img.width,img.height,0,0,canvas.width,canvas.height);var jpg=canvas.toDataURL("image/jpeg",.7);$scope.view.selecionado[campo.campo]=jpg,$scope.$apply()},img.src=reader.result},!1),reader.readAsDataURL(e.target.files[0])}}}var app=angular.module("app",["ngRoute","ngSanitize","ngCookies","ngAnimate","ngLocale","ui.utils.masks"]),configs={urlApi:"https://abacate.herokuapp.com/app/",limiteRegistros:10},rotas={home:"/solicitacoes",login:"/login",solicitacao:"/solicitacao",generico:"/:rota"};app.config(function($routeProvider,$locationProvider){$locationProvider.html5Mode(!1),$routeProvider.when(rotas.login,{templateUrl:"views/login.html"}).when(rotas.solicitacao,{templateUrl:"views/solicitacao.html"}).when(rotas.generico,{templateUrl:"views/generic.html"}).otherwise({redirectTo:rotas.home})}),app.controller("mainController",function($scope,$location,$http,$cookies,$timeout,$rootScope){$scope.hoje=new Date,$scope.exibirCarregando=!0,$scope.requisicoesPendentes=0,$scope.botoes={busca:!1,novo:!1},$scope.sessao={id:0,nome:null,auth:null,logado:!1},$scope.$on("$routeChangeStart",function(){$scope.exibirCarregando=!0,$scope.sessao.logado||void 0!==$cookies.get("auth")||"/login"!==$location.path()&&"/solicitacao"!==$location.path()&&($location.path(rotas.login),$scope.exibirCarregando=!1)}),$scope.$on("$routeChangeSuccess",function(){$scope.exibirCarregando=!1}),$scope.api=function(url,metodo,dados,retorno,sucesso,erro,callback,parametros,exibirErro=!0){var config={url:configs.urlApi+url,method:metodo,data:dados,headers:{"Content-Type":"application/json",Authorization:$scope.sessao.auth}};$scope.requisicoesPendentes++,$http(config).then(function(result){$scope.requisicoesPendentes--,void 0!==retorno&&void 0!==sucesso&&(retorno[sucesso]=result.data),void 0!==callback&&callback(parametros)},function(error){$scope.requisicoesPendentes--,void 0!==retorno&&void 0!==erro&&(retorno[erro]=error.data.message),exibirErro?$scope.exibirNotificacao("Erro",retorno[erro],!0,5e3):void 0!==callback&&callback(parametros)})},$scope.exibirNotificacao=function(titulo,mensagem,erro,tempo=2e3){$scope.notificacao={ativo:!0,titulo:titulo,mensagem:mensagem,erro:erro},$timeout(function(){$scope.notificacao.ativo=!1},tempo)},$scope.exibirConfirmacao=function(mensagem,callback,param){$scope.confirmacao={ativo:!0,mensagem:mensagem,confirmar:()=>callback(param)}},$scope.login=function(dados){let retorno={},basic=$cookies.get("auth");if(void 0!==dados)if(basic=btoa(dados.usuario+":"+dados.senha),dados.permanecerConectado){let expira=new Date;expira.setDate($scope.hoje.getDate()+30),$cookies.put("auth",basic,{expires:expira})}else $cookies.remove("auth");if(void 0!==basic){$scope.sessao.auth=basic;let dados=atob(basic).split(":");dados={usuario:dados[0],senha:dados[1]},$scope.api("usuarios/autenticar","POST",dados,retorno,"sucesso","erro",function(){if(void 0===retorno.erro){let usuario=retorno.sucesso;$scope.sessao.id=usuario.id,$scope.sessao.nome=usuario.nome,$scope.sessao.logado=!0,$location.path()===rotas.login&&$location.path(rotas.home)}else $scope.exibirNotificacao("Erro","Usuário e/ou senha inválidos",!0,5e3),$scope.logout()},null,!1)}},$scope.logout=function(){$scope.sessao={id:0,nome:null,auth:null,logado:!1},$cookies.remove("auth"),$location.path(rotas.login)},$scope.recuperar=function(dados){dados.senha===dados.repetir?(delete dados.repetir,$scope.api("usuarios/resetarSenha","PATCH",dados,{},"sucesso","erro",function(){$scope.exibirNotificacao("Sucesso","Senha atualizada com sucesso!")})):$scope.exibirNotificacao("Erro","As senhas digitadas não são iguais, digite novamente",!0,5e3)},$scope.novo=function(){$rootScope.$emit("novo",{})},$scope.login(),$(window).scroll(function(){0!==$scope.sessao.id&&$(window).scrollTop()+$(window).height()==$(document).height()&&$rootScope.$emit("mais",{})})}),app.controller("genericController",function($scope,$routeParams,$http,$q,$location,$rootScope){$scope.carregado=!1,$scope.paginaAtual=0,$scope.ordenacao={campo:null,ordem:!1},$scope.iniciar=function(){$scope.requisicoesPendentes++;let arquivo="models/"+$routeParams.rota+".json";$http.get(arquivo).then(function(result){if("object"==typeof result.data){if($scope.model=result.data,$scope.view={registros:[],selecionado:{},pesquisa:""},$scope.listar(),$scope.requisicoesPendentes--,$scope.carregado=!0,$scope.botoes.titulo=$scope.model.titulo,$scope.botoes.novo=!1,$scope.model.novo.ativo&&($scope.botoes.novo=!0,$rootScope.$on("novo",function(){$scope.editar($scope.model.novo.objeto)})),$rootScope.$on("mais",function(){0===$scope.requisicoesPendentes&&$scope.view.registros.length===($scope.paginaAtual+1)*configs.limiteRegistros&&($scope.paginaAtual++,$scope.listar())}),void 0!==$scope.model.filtros&&$scope.model.filtros.ativo){$scope.view.filtros=[];for(var i in $scope.model.campos){var atual=$scope.model.campos[i];if("select"===atual.tipo||"checkbox"===atual.tipo){var obj={};obj.incluir=!1,obj.campo=angular.copy(atual,obj.campo),$scope.view.filtros.push(obj)}}}}else $scope.exibirNotificacao("Erro","Falha ao carregar model",!0,5e3),$scope.requisicoesPendentes--},function(error){$scope.exibirNotificacao("Erro","Falha ao carregar model",!0,5e3),$scope.requisicoesPendentes--})},$scope.listar=function(){let obj={};if("object"==typeof $scope.model.busca.campo){let json=JSON.stringify($scope.model.busca.campo);obj=JSON.parse(json.replace("busca",$scope.view.pesquisa))}else obj[$scope.model.busca.campo]=$scope.view.pesquisa;let url=$scope.model.url+"/pesquisar?";if(url+="pagina="+$scope.paginaAtual+"&quantidade="+configs.limiteRegistros,null!==$scope.ordenacao.campo){let ordem=$scope.ordenacao.ordem?"asc":"desc";url+="&atributoOrdenado="+$scope.ordenacao.campo+"&ordem="+ordem}if(void 0!==$scope.model.filtros&&$scope.model.filtros.ativo){for(var i in $scope.view.filtros){let filtro=$scope.view.filtros[i];filtro.filtrar&&(obj[filtro.campo.campo]=filtro.valor)}$("#modal-filtros").modal("hide")}$scope.api(url,"POST",obj,$scope,"registros","erros",function(){$scope.paginaAtual>0?$scope.view.registros=$scope.view.registros.concat($scope.registros):$scope.view.registros=$scope.registros})},$scope.editar=function(obj){if(angular.copy(obj,$scope.view.selecionado),void 0!==$scope.view.selecionado[$scope.model.chave])for(var i in $scope.model.campos){let atual=$scope.model.campos[i];if("image"===atual.tipo){let url=$scope.model.url+"/"+$scope.view.selecionado[$scope.model.chave];$scope.api(url,"GET",null,$scope.view,"selecionado",null,function(){let campo=$scope.view.selecionado[atual.campo];null!==campo&&($scope.view.selecionado[atual.campo]=campo.replace("/app/",""))})}if("table"===$scope.model.campos[i].tipo){let atual=$scope.model.campos[i],url=atual.url+"/"+$scope.view.selecionado[atual.parametro];$scope.api(url,"GET",null,$scope.view.selecionado,atual.campo)}if("date"===$scope.model.campos[i].tipo||"datetime"===$scope.model.campos[i].tipo){let atual=$scope.model.campos[i],campo=$scope.view.selecionado[atual.campo];null!==campo&&($scope.view.selecionado[atual.campo]=campo+"Z","datetime"===$scope.model.campos[i].tipo&&($scope.view.selecionado[atual.campo+"-hora"]=campo.split("T")[1].split(".")[0]))}}else for(var i in $scope.model.campos){let atual=$scope.model.campos[i];if(("datetime"===atual.tipo||"date"===atual.tipo)&&atual.iniciar){let agora=new Date;if(agora=new Date(agora.getTime()-60*agora.getTimezoneOffset()*1e3),$scope.view.selecionado[atual.campo]=agora.toISOString(),"datetime"===atual.tipo){let campo=$scope.view.selecionado[atual.campo];$scope.view.selecionado[atual.campo+"-hora"]=campo.split("T")[1].split(".")[0]}}}$("#modal-editar").modal()},$scope.salvar=function(){let metodo="PATCH";if(void 0===$scope.view.selecionado[$scope.model.chave])metodo="POST";else for(var i in $scope.model.campos)if("table"===$scope.model.campos[i].tipo){let atual=$scope.model.campos[i],url=atual.url+"/"+$scope.view.selecionado[atual.parametro];$scope.api(url,"POST",$scope.view.selecionado[atual.campo])}for(var i in $scope.model.campos)if("date"===$scope.model.campos[i].tipo||"datetime"===$scope.model.campos[i].tipo){let atual=$scope.model.campos[i],campo=$scope.view.selecionado[atual.campo];if(void 0!==campo&&null!==campo&&("object"==typeof campo&&(campo=campo.toISOString()),$scope.view.selecionado[atual.campo]=campo.replace("Z",""),"datetime"===$scope.model.campos[i].tipo)){let hora=$scope.view.selecionado[atual.campo+"-hora"];$scope.view.selecionado[atual.campo]=campo.split("T")[0]+"T"+hora+".001"}}$scope.api($scope.model.url,metodo,$scope.view.selecionado,{},"sucesso","erro",function(){$scope.exibirNotificacao("Sucesso","Registro salvo com sucesso!",!1),$("#modal-editar").modal("toggle"),$scope.listar()})},$scope.excluir=function(id){$scope.exibirConfirmacao("Confirmar exclusão do registro?",function(){$scope.api($scope.model.url+"/"+id,"DELETE",null,{},"sucesso","erro",function(){$scope.exibirNotificacao("Sucesso","Registro excluído com sucesso!",!1),$scope.listar()})})},$scope.ordenar=function(campo){$scope.ordenacao.campo===campo&&($scope.ordenacao.ordem=!$scope.ordenacao.ordem),$scope.ordenacao.campo=campo,$scope.paginaAtual=0,$scope.listar()},$scope.descricao=function(item,atual){if("object"==typeof atual.descricao){var descricao="";for(var i in atual.descricao){var campos=atual.descricao[i].split("."),expressao="";for(var c in campos)expressao+="['"+campos[c]+"']";descricao+=eval("item"+expressao),i<atual.descricao.length-1&&(descricao+=atual.separador)}return descricao}return item[atual.descricao]},$scope.imprimir=function(){$scope.view.relatorio={titulo:$scope.model.imprimir.titulo,ordenar:$scope.model.chave,ordem:"asc",limite:0,campos:[]};for(var i in $scope.model.campos){var atual=$scope.model.campos[i],obj={};obj.incluir=!0,obj.nome=atual.nome,obj.campo=atual.campo,"select"===atual.tipo&&(obj.campo=atual.campo+"."+atual.descricao,"object"==typeof atual.descricao&&(obj.campo=atual.campo+"."+atual.descricao[0])),$scope.view.relatorio.campos.push(obj)}$("#modal-imprimir").modal()},$scope.imprimirOK=function(){var relatorio=$scope.view.relatorio,titulos=[],atributos=[];for(var i in relatorio.campos){var atual=relatorio.campos[i];atual.incluir&&(titulos.push(atual.nome),atributos.push(atual.campo))}var obj={};obj.authorization=$scope.sessao.auth,obj.nomeRelatorio=relatorio.titulo,obj.entidadeDeExemplo={tabela:atual.tabela},obj.titulos=titulos,obj.atributos=atributos,obj.atributoOrdenado=relatorio.ordenar,obj.ordem=relatorio.ordem,relatorio.limite>0&&(obj.pagina=0,obj.quantidade=relatorio.limite);var url=configs.urlApi+"pdf?";url+="entidade="+$scope.model.imprimir.entidade,url+="&obj="+btoa(encodeURI(JSON.stringify(obj))),window.open(url,"_blank")}});